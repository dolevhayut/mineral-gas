# מערכת עוזר AI חכם - תיעוד

## סקירה כללית

מערכת עוזר AI חכם היא כלי מתקדם המאפשר למנהלי מכירות לשאול שאלות בשפה חופשית על הזמנות, לקוחות וקריאות שירות. המערכת משתמשת ב-OpenAI Function Calling כדי להבין את השאלה, לבצע שאילתות במסד הנתונים ולהחזיר תשובות בשפה טבעית.

## תכונות עיקריות

### 1. שאילתות על הזמנות
- חיפוש הזמנות לפי שם לקוח או מספר טלפון
- סינון לפי חודש ושנה
- חיפוש לפי סטטוס הזמנה (ממתין, אושר, בדרך, נמסר, בוטל)
- חיפוש בטווח תאריכים

### 2. שאילתות על קריאות שירות
- חיפוש קריאות שירות לפי לקוח
- סינון לפי סטטוס (ממתין, בטיפול, הושלם, בוטל)

### 3. שאילתות על לקוחות
- חיפוש פרטי לקוח לפי שם או טלפון
- הצגת מידע מפורט על לקוח

### 4. דוחות והכנסות
- חישוב סך הכנסות לפי תקופה (חודש/שנה)
- ספירת הזמנות בתקופה מסוימת

## דוגמאות שימוש

### שאילתות על הזמנות

```
כמה הזמנות לקוח דוד כהן ביצע בחודש ינואר?
```
המערכת תזהה את שם הלקוח והחודש, תבצע שאילתה במסד הנתונים ותחזיר תשובה מפורטת.

```
הצג לי את כל ההזמנות בסטטוס ממתין
```
המערכת תחזיר רשימה של כל ההזמנות שממתינות לטיפול.

```
מה ההזמנות של לקוח עם טלפון 0501234567?
```
המערכת תחפש לקוח לפי מספר הטלפון ותציג את כל הזמנותיו.

### שאילתות על קריאות שירות

```
הצג לי את כל קריאות השירות הפתוחות
```
המערכת תחזיר רשימה של קריאות שירות בסטטוס "ממתין" או "בטיפול".

```
כמה קריאות שירות יש ללקוח משה לוי?
```
המערכת תחפש את הלקוח ותציג את כל קריאות השירות שלו.

### שאילתות על הכנסות

```
מה ההכנסות של חודש ינואר 2024?
```
המערכת תחשב את סך ההכנסות מהזמנות שנמסרו בחודש זה.

```
כמה הזמנות בוצעו החודש?
```
המערכת תחשב את מספר ההזמנות בחודש הנוכחי.

## התקנה והגדרה

### 1. התקנת חבילות

```bash
npm install openai
```

### 2. הגדרת משתני סביבה

הוסף את המפתח של OpenAI לקובץ `.env`:

```env
VITE_OPENAI_API_KEY=sk-your-openai-api-key-here
```

### 3. קבלת API Key מ-OpenAI

1. היכנס ל-[OpenAI Platform](https://platform.openai.com/)
2. עבור ל-API Keys
3. צור מפתח חדש
4. העתק את המפתח והוסף אותו לקובץ `.env`

## ארכיטקטורה טכנית

### קבצים עיקריים

1. **`src/services/aiQueryService.ts`** - שירות עיקרי לעיבוד שאלות
   - הגדרת פונקציות זמינות ל-OpenAI
   - מימוש פונקציות לשאילתות במסד הנתונים
   - עיבוד תשובות מ-OpenAI

2. **`src/components/AIQueryAssistant.tsx`** - קומפוננטת UI
   - ממשק משתמש לשאילת שאלות
   - הצגת היסטוריית שיחה
   - דוגמאות לשאלות נפוצות

3. **`src/pages/Index.tsx`** - אינטגרציה בדף הבית
   - הצגת הקומפוננטה רק למנהלים

### זרימת עבודה

```
1. משתמש שואל שאלה בשפה חופשית
   ↓
2. השאלה נשלחת ל-OpenAI עם הגדרות הפונקציות הזמינות
   ↓
3. OpenAI מזהה את הפונקציה המתאימה והפרמטרים
   ↓
4. הפונקציה מבוצעת (שאילתה במסד הנתונים)
   ↓
5. התוצאות נשלחות חזרה ל-OpenAI לעיבוד לשפה טבעית
   ↓
6. התשובה המעובדת מוצגת למשתמש
```

## פונקציות זמינות

### 1. `get_customer_orders_by_name`
מחזיר הזמנות של לקוח לפי שם.

**פרמטרים:**
- `customer_name` (חובה) - שם הלקוח או חלק משמו
- `month` (אופציונלי) - מספר החודש (1-12)
- `year` (אופציונלי) - השנה

### 2. `get_customer_orders_by_phone`
מחזיר הזמנות של לקוח לפי מספר טלפון.

**פרמטרים:**
- `phone` (חובה) - מספר טלפון
- `month` (אופציונלי) - מספר החודש (1-12)
- `year` (אופציונלי) - השנה

### 3. `get_orders_by_status`
מחזיר הזמנות לפי סטטוס.

**פרמטרים:**
- `status` (חובה) - pending, confirmed, in_transit, delivered, cancelled
- `month` (אופציונלי) - מספר החודש (1-12)
- `year` (אופציונלי) - השנה

### 4. `get_orders_by_date_range`
מחזיר הזמנות בטווח תאריכים.

**פרמטרים:**
- `start_date` (חובה) - תאריך התחלה (YYYY-MM-DD)
- `end_date` (חובה) - תאריך סיום (YYYY-MM-DD)

### 5. `get_service_requests_by_customer`
מחזיר קריאות שירות של לקוח.

**פרמטרים:**
- `customer_name` (חובה) - שם הלקוח
- `status` (אופציונלי) - pending, in_progress, completed, cancelled

### 6. `get_service_requests_by_status`
מחזיר קריאות שירות לפי סטטוס.

**פרמטרים:**
- `status` (חובה) - pending, in_progress, completed, cancelled

### 7. `get_customer_details`
מחזיר פרטי לקוח.

**פרמטרים:**
- `search_term` (חובה) - שם או מספר טלפון

### 8. `get_total_revenue`
מחזיר סך הכנסות.

**פרמטרים:**
- `month` (אופציונלי) - מספר החודש (1-12)
- `year` (אופציונלי) - השנה

## אבטחה ושיקולים

### ⚠️ חשוב - אבטחה

**הערה חשובה:** הקוד הנוכחי משתמש ב-`dangerouslyAllowBrowser: true` שמאפשר שימוש ב-OpenAI API מצד הלקוח. זה מתאים לפיתוח בלבד!

**לסביבת ייצור (Production):**

1. **העבר את הלוגיקה לצד השרת:**
   - צור Supabase Edge Function או API endpoint
   - העבר את ה-API key של OpenAI לצד השרת
   - הלקוח ישלח שאלות ל-API שלך, לא ישירות ל-OpenAI

2. **הגן על ה-API key:**
   - אל תחשוף את ה-API key בקוד הלקוח
   - שמור את המפתח רק בצד השרת

3. **הוסף אימות:**
   - ודא שרק מנהלים יכולים לגשת לשירות
   - הוסף rate limiting למניעת שימוש יתר

### דוגמה: Supabase Edge Function

```typescript
// supabase/functions/ai-query/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import OpenAI from 'https://esm.sh/openai@4.20.1'

serve(async (req) => {
  // בדוק אימות
  const authHeader = req.headers.get('Authorization')
  if (!authHeader) {
    return new Response('Unauthorized', { status: 401 })
  }

  const { query } = await req.json()
  
  const openai = new OpenAI({
    apiKey: Deno.env.get('OPENAI_API_KEY')
  })

  // עיבוד השאלה...
  
  return new Response(JSON.stringify({ answer }), {
    headers: { 'Content-Type': 'application/json' }
  })
})
```

## הרחבות עתידיות

### רעיונות לשיפור:

1. **תמיכה בשאלות מורכבות יותר:**
   - השוואות בין תקופות
   - ניתוח מגמות
   - תחזיות

2. **ויזואליזציה:**
   - יצירת גרפים אוטומטית
   - הצגת תוצאות בטבלאות

3. **שמירת היסטוריה:**
   - שמירת שאלות נפוצות
   - למידה משאלות קודמות

4. **הרחבת יכולות:**
   - עדכון נתונים (לא רק קריאה)
   - שליחת התראות
   - יצירת דוחות מותאמים אישית

## פתרון בעיות נפוצות

### שגיאה: "API key not found"
**פתרון:** ודא שהוספת את `VITE_OPENAI_API_KEY` לקובץ `.env` והפעלת מחדש את שרת הפיתוח.

### שגיאה: "Rate limit exceeded"
**פתרון:** חרגת ממכסת ה-API של OpenAI. המתן מספר דקות או שדרג את התוכנית שלך.

### התשובות לא מדויקות
**פתרון:** 
- בדוק שהנתונים במסד הנתונים נכונים
- שפר את תיאור הפונקציות ב-`functions` array
- הוסף דוגמאות לשאלות נפוצות

### הקומפוננטה לא מוצגת
**פתרון:** ודא שהמשתמש מחובר כמנהל (`role: 'admin'` ב-localStorage).

## תמיכה

לשאלות או בעיות, פנה למפתח המערכת.

---

**גרסה:** 1.0.0  
**תאריך עדכון אחרון:** נובמבר 2024

